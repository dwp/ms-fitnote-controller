version: '2.1'
networks:
  test:
services:

  localstack:
    container_name: localstack
    image: localstack/localstack:4.6.0@sha256:5a97e0f9917a3f0d9630bb13b9d8ccf10cbe52f33252807d3b4e21418cc21348
    environment:
      SERVICES: ${LOCALSTACK_SERVICES}
      LOCALSTACK_HOST: ${LOCALSTACK_HOSTNAME}
    healthcheck:
      test: ["CMD", "curl", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 10
    expose:
      - "4566"
    networks:
      - test
    volumes:
      - ./localstack/docker-entrypoint-initaws.d:/docker-entrypoint-initaws.d

  redis-cluster:
    image: bitnami/redis-cluster@sha256:f3ba5f05dd817d14d661dba900fc6f56cf8efeff70d15af6ce6738045873f60f
    ports:
      - '6379:6379'
    healthcheck:
      test: [ "CMD", "redis-cli", "-p", "6379", "ping" ]
      interval: 1s
      timeout: 3s
      retries: 30
    environment:
      - 'ALLOW_EMPTY_PASSWORD=yes'
      - 'REDIS_CLUSTER_REPLICAS=0'
      - 'REDIS_NODES=redis-cluster redis-cluster redis-cluster redis-cluster redis-cluster'
      - 'REDIS_CLUSTER_CREATOR=yes'
      - 'REDIS_CLUSTER_DYNAMIC_IPS=no'
      - 'REDIS_CLUSTER_ANNOUNCE_IP=redis-cluster'
    networks:
      - test

  cucumber-tests:
    image: ${MAVEN_IMAGE}
    entrypoint: /bin/bash -c
    command:
      - |
        sh /usr/src/scripts/InstallImageMagick.sh
        sleep 5 #wait for keys to be created once localstack services are available (aws cli not available)
        mvn -Dtest=uk.gov.dwp.health.fitnotecontroller.integration.RunCukesTest ${MVN_OPTS} ${MVN_CLI_OPTS} test
    working_dir: /usr/src
    volumes:
      - .:/usr/src
      - ${MVN_M2}:/root/.m2
      - ${MVN_SETTINGS_FILE}:/root/.m2/settings.xml
      - ${APT_DIR}:/root/.apt
      - ${MAGICK_DIR}:/usr/src/magick
    environment:
      - JVM_OPTS=-Xmx12g -Xms12g -XX:MaxPermSize=2048m
      - IP=0.0.0.0
      - APT_DIR=/root/.apt

    networks:
      - test
    depends_on:
      redis-cluster:
        condition: service_healthy
      localstack:
        condition: service_healthy
